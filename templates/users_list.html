{% load static %}
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Users • Admin</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
		<style>
			body { background: #f8f9fc; }
			.table thead th { white-space: nowrap; }
			/* Allow dropdowns to overflow the responsive table container */
			.table-responsive { overflow: visible; }
			/* Improve dropdown visuals */
			.table .dropdown-menu { min-width: 10rem; }
			/* Delete overlay animation */
			.delete-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(15, 23, 42, .55); z-index: 1080; }
			.overlay-content { display: flex; flex-direction: column; align-items: center; justify-content: center; }
			.check-wrap { width: 84px; height: 84px; border-radius: 50%; border: 4px solid rgba(255,255,255,.65); display:flex; align-items:center; justify-content:center; animation: spin 1s linear infinite; }
			.check-wrap i { color: #22c55e; font-size: 44px; filter: drop-shadow(0 2px 6px rgba(0,0,0,.35)); }
			@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
		</style>
	</head>
	<body>
		<nav class="navbar navbar-light bg-white shadow-sm">
			<div class="container">
				<a class="navbar-brand d-flex align-items-center gap-2" href="/dashboard/">
					<i class="bi-speedometer2"></i>
					<span>Admin</span>
				</a>
				<div class="ms-auto">
					<a href="/dashboard/" class="btn btn-outline-primary btn-sm"><i class="bi-arrow-left"></i> Back</a>
				</div>
			</div>
		</nav>

		<div class="container py-4">
			{% if messages %}
				<div class="mb-3">
					{% for message in messages %}
						<div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">{{ message }}</div>
					{% endfor %}
				</div>
			{% endif %}
			<div class="d-flex justify-content-between align-items-center mb-3">
				<h1 class="h3 mb-0">Users</h1>
				<div class="d-flex gap-2">
					<a href="/dashboard/users/new/" class="btn btn-primary"><i class="bi-person-plus"></i> Add User</a>
					<a href="/admin/auth/user/" class="btn btn-outline-secondary"><i class="bi-box-arrow-up-right"></i> Open in Django Admin</a>
				</div>
			</div>

			<div class="card shadow-sm">
				<div class="table-responsive">
					<table class="table table-hover align-middle mb-0">
						<thead class="table-light">
							<tr>
								<th>Username</th>
								<th>Name</th>
								<th>Email</th>
								<th>Type</th>
								<th>Status</th>
								<th>Last login</th>
								<th>Joined</th>
                                <th class="text-end">Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for u in users %}
							<tr>
								<td><span class="fw-semibold">{{ u.username }}</span></td>
								<td>{{ u.first_name }} {{ u.last_name }}</td>
								<td>{{ u.email }}</td>
								<td>
									{% if u.is_superuser %}
										<span class="badge text-bg-dark">Superuser</span>
									{% elif u.is_staff %}
										<span class="badge text-bg-primary">Staff</span>
									{% else %}
										<span class="badge text-bg-secondary">User</span>
									{% endif %}
								</td>
								<td>
									{% if u.is_active %}
										<span class="badge text-bg-success">Active</span>
									{% else %}
										<span class="badge text-bg-secondary">Inactive</span>
									{% endif %}
								</td>
								<td>{{ u.last_login|default:'—' }}</td>
								<td>{{ u.date_joined }}</td>
								<td class="text-end">
									<div class="dropdown position-static">
										<button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
											<i class="bi-pencil"></i>
										</button>
										<ul class="dropdown-menu dropdown-menu-end shadow">
											<li>
												<a class="dropdown-item" href="{% url 'user_update' u.id %}"><i class="bi-pencil-square me-2"></i>Update</a>
											</li>
											<li><hr class="dropdown-divider"></li>
										<li class="px-3 py-2">
											<form method="post" action="{% url 'user_delete' u.id %}" onsubmit="return confirm('Delete this user permanently?');" class="js-delete-form">
													{% csrf_token %}
													<button type="submit" class="btn btn-danger btn-sm w-100"><i class="bi-trash me-2"></i>Delete</button>
												</form>
											</li>
										</ul>
									</div>
								</td>
							</tr>
							{% empty %}{% endfor %}

							{# Custom users coming from UserDetail model #}
                            {% for cu in custom_users %}
                            <tr>
                                <td><span class="fw-semibold">{{ cu.email|default:'—' }}</span></td>
                                <td>{{ cu.first_name }} {{ cu.last_name }}</td>
                                <td>{{ cu.email|default:'—' }}</td>
                                <td><span class="badge text-bg-secondary">User</span></td>
                                <td><span class="badge text-bg-success">Active</span></td>
                                <td>—</td>
                                <td>{{ cu.created_at }}</td>
                                <td class="text-end">
                                    <div class="dropdown position-static">
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                                            <i class="bi-pencil"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow">
                                            <li>
                                                <a class="dropdown-item" href="{% url 'custom_user_update' cu.id %}"><i class="bi-pencil-square me-2"></i>Update</a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li class="px-3 py-2">
                                                <form method="post" action="{% url 'custom_user_delete' cu.id %}" onsubmit="return confirm('Delete this user permanently?');" class="js-delete-form">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-danger btn-sm w-100"><i class="bi-trash me-2"></i>Delete</button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
							{% empty %}
							<tr><td colspan="8" class="text-center text-muted py-4">No users found.</td></tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

		<!-- Delete animation overlay -->
		<div id="deleteOverlay" class="delete-overlay d-none" aria-hidden="true">
			<div class="overlay-content">
				<div class="check-wrap">
					<i class="bi-check-circle"></i>
				</div>
				<div class="mt-3 text-white fw-semibold">Deleting...</div>
			</div>
		</div>
		<script>
		(function(){
			const dropdownEls = document.querySelectorAll('.table .dropdown');
			dropdownEls.forEach(function(wrapper){
				const toggle = wrapper.querySelector('[data-bs-toggle="dropdown"]');
				if (!toggle) return;
				const instance = new bootstrap.Dropdown(toggle, { autoClose: 'outside' });
				wrapper.addEventListener('mouseenter', function(){ instance.show(); });
				wrapper.addEventListener('mouseleave', function(){ instance.hide(); });
			});

			// Delete animation flow: show overlay briefly, then submit
			const overlay = document.getElementById('deleteOverlay');
				document.querySelectorAll('.js-delete-form').forEach(function(form){
				form.addEventListener('submit', function(e){
					// If already handled (to avoid loops after timeout-triggered submit), skip
					if (form.dataset.handled === '1') { return; }
					e.preventDefault();
					if (overlay) { overlay.classList.remove('d-none'); }
						// Safety: auto-hide overlay after 6s if navigation is blocked
						var safetyHide = setTimeout(function(){ if (overlay) overlay.classList.add('d-none'); }, 6000);
						setTimeout(function(){ form.dataset.handled = '1'; form.submit(); clearTimeout(safetyHide); }, 900);
				});
			});
		})();
		</script>
	</body>
</html>

